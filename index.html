<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Schedule Generator</title>
    
    <!-- Metronic 9 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --kt-primary: #009ef7;
            --kt-primary-light: #f1faff;
            --kt-secondary: #e4e6ef;
            --kt-success: #50cd89;
            --kt-info: #7239ea;
            --kt-warning: #ffc700;
            --kt-danger: #f1416c;
            --kt-gray-100: #f9f9f9;
            --kt-gray-200: #f4f4f4;
            --kt-gray-300: #e1e3ea;
            --kt-gray-400: #b5b5c3;
            --kt-gray-500: #a1a5b7;
            --kt-gray-600: #7e8299;
            --kt-gray-700: #5e6278;
            --kt-gray-800: #3f4254;
            --kt-gray-900: #181c32;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--kt-gray-100);
            color: var(--kt-gray-800);
        }

        .app-header {
            background: linear-gradient(135deg, var(--kt-primary) 0%, var(--kt-info) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 0.5rem 1.5rem 0.5rem rgba(0, 0, 0, 0.075);
        }

        .card {
            border: 0;
            box-shadow: 0 0.1rem 1rem 0.25rem rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem;
        }

        .card-header {
            background-color: transparent;
            border-bottom: 1px solid var(--kt-gray-300);
            padding: 1.5rem 2rem;
        }

        .card-body {
            padding: 2rem;
        }

        .form-label {
            color: var(--kt-gray-700);
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border: 1px solid var(--kt-gray-300);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            transition: all 0.15s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--kt-primary);
            box-shadow: 0 0 0 0.2rem rgba(0, 158, 247, 0.15);
        }

        .btn {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background-color: var(--kt-primary);
            border-color: var(--kt-primary);
        }

        .btn-success {
            background-color: var(--kt-success);
            border-color: var(--kt-success);
        }

        .btn-danger {
            background-color: var(--kt-danger);
            border-color: var(--kt-danger);
        }

        .btn-light-primary {
            background-color: var(--kt-primary-light);
            border-color: transparent;
            color: var(--kt-primary);
        }

        /* Football Animation Styles */
        .football-container {
            position: relative;
            overflow: visible;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-football-kick {
            background: linear-gradient(135deg, #8D4F2B 0%, #A0522D 50%, #8D4F2B 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 200px;
            height: 120px;
            position: relative;
            overflow: visible;
            box-shadow: 
                inset 0 0 0 3px #FFFFFF,
                inset 0 -8px 0 2px #FFFFFF,
                inset 0 8px 0 2px #FFFFFF,
                0 8px 25px rgba(141, 79, 43, 0.6);
            transition: all 0.3s ease;
        }

        .btn-football-kick::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 60%;
            background: white;
            border-radius: 1px;
        }

        .btn-football-kick::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 2px;
            background: white;
            border-radius: 1px;
            box-shadow: 
                0 15px 0 white,
                0 30px 0 white,
                0 45px 0 white;
        }

        .btn-football-kick:hover:not(.kicking) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 
                inset 0 0 0 3px #FFFFFF,
                inset 0 -8px 0 2px #FFFFFF,
                inset 0 8px 0 2px #FFFFFF,
                0 12px 30px rgba(141, 79, 43, 0.8);
        }

        .btn-football-kick .btn-content {
            position: relative;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .btn-football-kick.kicking {
            animation: kickFootball 2s ease-out forwards;
        }

        .btn-football-kick.returning {
            animation: returnButton 0.8s ease-out forwards;
        }

        /* Regular button styling to override football when switching sports */
        .btn-primary.btn-lg {
            border-radius: 0.5rem !important;
            width: auto !important;
            height: auto !important;
            background: var(--kt-primary) !important;
            box-shadow: 0 0.1rem 1rem 0.25rem rgba(0, 0, 0, 0.05) !important;
        }

        .btn-primary.btn-lg::before,
        .btn-primary.btn-lg::after {
            display: none !important;
        }

        .btn-primary.btn-lg .btn-content {
            height: auto !important;
        }

        /* Responsive football button */
        @media (max-width: 768px) {
            .btn-football-kick {
                width: 160px;
                height: 100px;
            }
            
            .btn-football-kick .btn-content {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .btn-football-kick {
                width: 140px;
                height: 85px;
            }
            
            .btn-football-kick .btn-content {
                font-size: 0.75rem;
            }
        }

        @keyframes kickFootball {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            15% {
                transform: scale(0.8) rotate(45deg) translateX(100px) translateY(-50px);
            }
            35% {
                transform: scale(0.6) rotate(135deg) translateX(300px) translateY(-150px);
            }
            60% {
                transform: scale(0.4) rotate(270deg) translateX(600px) translateY(-200px);
            }
            80% {
                transform: scale(0.3) rotate(405deg) translateX(900px) translateY(-150px);
                opacity: 1;
            }
            100% {
                transform: scale(0.2) rotate(540deg) translateX(1200px) translateY(-100px);
                opacity: 0;
            }
        }

        @keyframes returnButton {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .goal-posts {
            position: absolute;
            right: -100px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 4rem;
            opacity: 0;
            z-index: 999;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .goal-posts.show {
            animation: showGoalPosts 2.5s ease-out forwards;
        }

        @keyframes showGoalPosts {
            0% {
                opacity: 0;
                transform: translateY(-50%) scale(0.8);
            }
            40% {
                opacity: 0;
            }
            50% {
                opacity: 1;
                transform: translateY(-50%) scale(1.2);
            }
            60% {
                transform: translateY(-50%) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50%) scale(1);
            }
        }

        .kick-foot {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            opacity: 0;
            z-index: 1001;
        }

        .kick-foot.kicking {
            animation: footKick 0.6s ease-out forwards;
        }

        @keyframes footKick {
            0% {
                opacity: 0;
                transform: translateY(-50%) translateX(-20px) rotate(-30deg);
            }
            30% {
                opacity: 1;
                transform: translateY(-50%) translateX(0px) rotate(0deg);
            }
            70% {
                opacity: 1;
                transform: translateY(-50%) translateX(40px) rotate(20deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-50%) translateX(60px) rotate(30deg);
            }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(46, 125, 50, 0.95);
            border-radius: inherit;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .btn-football-kick .loading-overlay {
            background: rgba(141, 79, 43, 0.95);
            border-radius: 50%;
        }

        .loading-overlay.show {
            opacity: 1;
        }

        .loading-overlay .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }

        @keyframes slideIn {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Prevent button text from wrapping during animations */
        #generateBtnText {
            transition: opacity 0.3s ease;
            white-space: nowrap;
        }

        .btn i {
            transition: opacity 0.3s ease;
        }

        .rivalry-card {
            background-color: var(--kt-gray-100);
            border: 1px solid var(--kt-gray-300);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .schedule-week {
            background: white;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 0.1rem 1rem 0.25rem rgba(0, 0, 0, 0.05);
        }

        .schedule-week-header {
            background: linear-gradient(90deg, var(--kt-primary) 0%, var(--kt-info) 100%);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1rem;
        }

        .schedule-week-header.bg-warning {
            background: linear-gradient(90deg, var(--kt-warning) 0%, #ff8c00 100%);
            color: var(--kt-gray-900);
        }

        .schedule-week-body {
            padding: 1.5rem;
        }

        .game-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--kt-gray-100);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .game-item:last-child {
            margin-bottom: 0;
        }

        .team-badge {
            background-color: var(--kt-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .vs-divider {
            color: var(--kt-gray-500);
            font-weight: 600;
            margin: 0 1rem;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--kt-success) 0%, #20c997 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stats-item {
            text-align: center;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        .stats-label {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .alert {
            border: 0;
            border-radius: 0.5rem;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .team-input-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .team-number {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--kt-primary);
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 5;
        }

        .team-input {
            padding-left: 3rem;
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 1.5rem 0;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .rivalry-card {
                padding: 0.75rem;
            }
            
            .game-item {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
            
            .vs-divider {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="app-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="mb-2">
                        <i class="fas fa-calendar-alt me-3"></i>
                        Sports Schedule Generator
                    </h1>
                    <p class="mb-0 opacity-75">Create professional schedules for any sport with dynamic team counts and flexible configurations</p>
                </div>
                <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                    <div class="d-flex align-items-center justify-content-lg-end gap-3">
                        <i class="fas fa-users fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Configuration Section -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-cog text-primary me-2"></i>
                            League Configuration
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label">Sport Type</label>
                                <select class="form-select" id="sportType" onchange="updateSportDefaults()">
                                    <option value="fantasy_football">Fantasy Football</option>
                                    <option value="fantasy_baseball">Fantasy Baseball</option>
                                    <option value="basketball">Fantasy Basketball</option>
                                    <option value="soccer">Fantasy Soccer</option>
                                    <option value="custom">Custom Sport</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label">Number of Teams</label>
                                <select class="form-select" id="teamCount" onchange="updateTeamInputs()">
                                    <option value="8">8 Teams</option>
                                    <option value="10">10 Teams</option>
                                    <option value="12" selected>12 Teams</option>
                                    <option value="14">14 Teams</option>
                                    <option value="16">16 Teams</option>
                                    <option value="18">18 Teams</option>
                                    <option value="20">20 Teams</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label">Total Weeks</label>
                                <input type="number" class="form-control" id="totalWeeks" value="14" min="4" max="30" onchange="calculateScheduleInfo()">
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label">Rivalry Week Selection</label>
                                <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#rivalryWeekModal">
                                    <i class="fas fa-calendar-alt me-2"></i>Select Rivalry Weeks
                                </button>
                            </div>
                        </div>

                        <!-- Schedule Information -->
                        <div class="alert alert-info" id="scheduleInfo">
                            <h6><i class="fas fa-info-circle me-2"></i>Schedule Information</h6>
                            <div id="scheduleDetails"></div>
                        </div>

                        <!-- Selected Rivalry Weeks Display -->
                        <div class="alert alert-warning" id="rivalryWeeksDisplay" style="display: none;">
                            <h6><i class="fas fa-sword me-2"></i>Selected Rivalry Weeks</h6>
                            <div id="selectedWeeksText">No rivalry weeks selected</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <!-- Statistics -->
                <div class="stats-card" id="statsCard" style="display: none;">
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="stats-item">
                                <div class="stats-number" id="totalGamesCount">0</div>
                                <div class="stats-label">Total Games</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stats-item">
                                <div class="stats-number" id="roundRobinsCount">0</div>
                                <div class="stats-label">Round Robins</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stats-item">
                                <div class="stats-number" id="gamesPerTeamCount">0</div>
                                <div class="stats-label">Games/Team</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stats-item">
                                <div class="stats-number" id="weeksUsedCount">0</div>
                                <div class="stats-label">Weeks Used</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-rocket text-success me-2"></i>
                            Quick Actions
                        </h3>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-light-primary w-100 mb-3" onclick="generateRandomTeamNames()">
                            <i class="fas fa-random me-2"></i>Generate Random Team Names
                        </button>
                        <button class="btn btn-light-primary w-100 mb-3" onclick="autoGenerateRivalries()">
                            <i class="fas fa-link me-2"></i>Generate All Possible Rivalries
                        </button>
                        <button class="btn btn-light-primary w-100" onclick="clearAllData()">
                            <i class="fas fa-trash me-2"></i>Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teams Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users text-success me-2"></i>
                    Team Names
                </h3>
            </div>
            <div class="card-body">
                <div class="row" id="teamsContainer">
                    <!-- Team inputs will be generated here -->
                </div>
            </div>
        </div>

        <!-- Rivalries Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-sword text-warning me-2"></i>
                    Rivalry Matchups
                </h3>
                <button class="btn btn-success btn-sm" onclick="addRivalry()">
                    <i class="fas fa-plus me-1"></i>Add Rivalry
                </button>
            </div>
            <div class="card-body">
                <div id="rivalriesContainer">
                    <!-- Rivalry inputs will be generated here -->
                </div>
                <div class="text-muted" id="rivalryHelp">
                    <i class="fas fa-info-circle me-1"></i>
                    <span id="rivalryHelpText">Rivalries create special matchup weeks. Each team can only have one rivalry partner.</span>
                </div>
            </div>
        </div>

        <!-- Generate Button -->
        <div class="text-center mb-4 football-container">
            <div class="goal-posts" id="goalPosts">🥅</div>
            <div class="kick-foot" id="kickFoot">🦵</div>
            <button class="btn btn-primary btn-lg px-5" id="generateBtn" onclick="generateSchedule()">
                <div class="loading-overlay" id="loadingOverlay">
                    <span class="spinner-border spinner-border-sm text-white"></span>
                </div>
                <div class="btn-content">
                    <i class="fas fa-magic me-2"></i>
                    <span id="generateBtnText">Generate Schedule</span>
                </div>
            </button>
        </div>

        <!-- Schedule Output -->
        <div id="scheduleOutput" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-calendar-check text-success me-2"></i>
                        Generated Schedule
                    </h3>
                    <div>
                        <button class="btn btn-success me-2" onclick="downloadSchedule()">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                        <button class="btn btn-light" onclick="printSchedule()">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="scheduleContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rivalry Week Selection Modal -->
    <div class="modal fade" id="rivalryWeekModal" tabindex="-1" aria-labelledby="rivalryWeekModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rivalryWeekModalLabel">
                        <i class="fas fa-calendar-alt text-primary me-2"></i>
                        Select Rivalry Weeks
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-4">Choose which weeks will be dedicated to rivalry matchups. During these weeks, only rivalry pairs will play against each other.</p>
                    
                    <div class="row" id="weekCheckboxContainer">
                        <!-- Week checkboxes will be generated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRivalryWeeks()">Save Selection</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let teams = [];
        let rivalries = [];
        let selectedRivalryWeeks = [];
        let currentSchedule = null;
        let scheduleConfig = {
            teamCount: 12,
            totalWeeks: 14,
            rivalryWeeks: [],
            sportType: 'fantasy_football'
        };

        // Sport configurations
        const sportConfigs = {
            fantasy_football: {
                name: 'Fantasy Football',
                defaultTeams: ['Ders', 'Brock', 'Nick', 'Marc', 'Rick', 'Spencer', 'Matt', 'Eli', 'ben', 'Sam', 'Paul', 'Addi'],
                defaultWeeks: 14,
                suggestedRivalryWeeks: [1, 14]
            },
            fantasy_baseball: {
                name: 'Fantasy Baseball',
                defaultTeams: ['Yankees', 'Red Sox', 'Dodgers', 'Giants', 'Cubs', 'Cardinals', 'Astros', 'Rangers', 'Braves', 'Phillies', 'Mets', 'Nationals'],
                defaultWeeks: 22,
                suggestedRivalryWeeks: [1, 11, 22]
            },
            basketball: {
                name: 'Fantasy Basketball',
                defaultTeams: ['Lakers', 'Celtics', 'Warriors', 'Bulls', 'Heat', 'Spurs', 'Knicks', 'Nets', 'Mavs', 'Nuggets', 'Suns', 'Clippers'],
                defaultWeeks: 20,
                suggestedRivalryWeeks: [1, 20]
            },
            soccer: {
                name: 'Fantasy Soccer',
                defaultTeams: ['Arsenal', 'Chelsea', 'Liverpool', 'ManCity', 'ManUnited', 'Tottenham', 'Newcastle', 'Brighton', 'Villa', 'West Ham', 'Wolves', 'Crystal Palace'],
                defaultWeeks: 18,
                suggestedRivalryWeeks: [1, 18]
            },
            custom: {
                name: 'Custom Sport',
                defaultTeams: [],
                defaultWeeks: 14,
                suggestedRivalryWeeks: [1, 14]
            }
        };

        // Initialize the application
        function initializeApp() {
            updateSportDefaults(); // This already calls updateGenerateButton()
            updateTeamInputs();
            generateWeekCheckboxes();
            calculateScheduleInfo();
        }

        function updateSportDefaults() {
            const sportType = document.getElementById('sportType').value;
            const config = sportConfigs[sportType];
            
            scheduleConfig.sportType = sportType;
            
            if (sportType !== 'custom') {
                document.getElementById('totalWeeks').value = config.defaultWeeks;
                scheduleConfig.totalWeeks = config.defaultWeeks;
                
                // Set suggested rivalry weeks
                selectedRivalryWeeks = [...config.suggestedRivalryWeeks];
                scheduleConfig.rivalryWeeks = selectedRivalryWeeks;
                updateRivalryWeeksDisplay();
            }
            
            // Update generate button based on sport
            updateGenerateButton();
            
            updateTeamInputs();
            generateWeekCheckboxes();
            calculateScheduleInfo();
        }

        function updateGenerateButton() {
            const sportType = document.getElementById('sportType').value;
            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('generateBtnText');
            const btnIcon = btn.querySelector('i');
            
            // Remove all sport-specific classes
            btn.classList.remove('btn-football-kick', 'btn-primary');
            
            if (sportType === 'fantasy_football') {
                btn.classList.add('btn-football-kick');
                btnIcon.className = 'fas fa-play me-2';
                btnText.textContent = 'KICK!';
            } else {
                btn.classList.add('btn-primary');
                
                switch(sportType) {
                    case 'fantasy_baseball':
                        btnIcon.className = 'fas fa-baseball-ball me-2';
                        btnText.textContent = 'Pitch Schedule!';
                        break;
                    case 'basketball':
                        btnIcon.className = 'fas fa-basketball-ball me-2';
                        btnText.textContent = 'Shoot Schedule!';
                        break;
                    case 'soccer':
                        btnIcon.className = 'fas fa-futbol me-2';
                        btnText.textContent = 'Score Schedule!';
                        break;
                    default:
                        btnIcon.className = 'fas fa-magic me-2';
                        btnText.textContent = 'Generate Schedule';
                }
            }
        }

        function triggerFootballKick() {
            const btn = document.getElementById('generateBtn');
            const btnContent = btn.querySelector('.btn-content');
            const goalPosts = document.getElementById('goalPosts');
            const kickFoot = document.getElementById('kickFoot');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // Hide button content during kick
            btnContent.style.opacity = '0';
            
            // Start the kick sequence
            btn.classList.add('kicking');
            goalPosts.classList.add('show');
            kickFoot.classList.add('kicking');
            
            // Show loading overlay after kick starts
            setTimeout(() => {
                loadingOverlay.classList.add('show');
            }, 500);
            
            // Return button after kick completes
            setTimeout(() => {
                btn.classList.remove('kicking');
                btn.classList.add('returning');
                loadingOverlay.classList.remove('show');
                
                // Restore content with kicking text
                btnContent.style.opacity = '1';
                document.getElementById('generateBtnText').textContent = 'Kicking...';
                
                setTimeout(() => {
                    btn.classList.remove('returning');
                }, 800);
                
            }, 2000);
            
            // Clean up animations after everything completes
            setTimeout(() => {
                goalPosts.classList.remove('show');
                kickFoot.classList.remove('kicking');
                console.log('🎉 FIELD GOAL! Schedule generated successfully! 🎉');
            }, 3000);
        }

        function updateTeamInputs() {
            const teamCount = parseInt(document.getElementById('teamCount').value);
            const sportType = document.getElementById('sportType').value;
            const config = sportConfigs[sportType];
            
            scheduleConfig.teamCount = teamCount;
            
            // Resize teams array
            while (teams.length < teamCount) {
                const index = teams.length;
                if (config.defaultTeams && config.defaultTeams[index]) {
                    teams.push(config.defaultTeams[index]);
                } else {
                    teams.push(`Team ${index + 1}`);
                }
            }
            teams = teams.slice(0, teamCount);
            
            // Remove excess rivalries if team count decreased
            const maxRivalries = Math.floor(teamCount / 2);
            if (rivalries.length > maxRivalries) {
                rivalries = rivalries.slice(0, maxRivalries);
            }
            
            generateTeamInputsUI();
            generateRivalryInputsUI();
            calculateScheduleInfo();
        }

        function generateTeamInputsUI() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '';
            
            teams.forEach((team, index) => {
                const colDiv = document.createElement('div');
                colDiv.className = 'col-lg-4 col-md-6 mb-3';
                
                colDiv.innerHTML = `
                    <div class="team-input-container">
                        <div class="team-number">${index + 1}</div>
                        <input type="text" class="form-control team-input" 
                               value="${team}" 
                               onchange="updateTeam(${index}, this.value)"
                               placeholder="Enter team name">
                    </div>
                `;
                
                container.appendChild(colDiv);
            });
        }

        function generateRivalryInputsUI() {
            const container = document.getElementById('rivalriesContainer');
            container.innerHTML = '';
            
            rivalries.forEach((rivalry, index) => {
                addRivalryInputUI(index, rivalry[0], rivalry[1]);
            });
            
            if (rivalries.length === 0) {
                const maxRivalries = Math.floor(teams.length / 2);
                container.innerHTML = `<div class="text-muted text-center py-4">No rivalries configured. You can create up to ${maxRivalries} rivalry pairs with ${teams.length} teams.</div>`;
            }
            
            updateAddRivalryButton();
        }

        function getAvailableTeamsForRivalry(rivalryIndex, position) {
            // Get all teams that are already used in other rivalries
            const usedTeams = new Set();
            
            rivalries.forEach((rivalry, index) => {
                if (index !== rivalryIndex) { // Don't count the current rivalry
                    if (rivalry[0]) usedTeams.add(rivalry[0]);
                    if (rivalry[1]) usedTeams.add(rivalry[1]);
                }
            });
            
            // For the current rivalry, don't exclude the other position's team
            // (so Team A can't be both positions in the same rivalry)
            const currentRivalry = rivalries[rivalryIndex];
            if (currentRivalry) {
                const otherPosition = position === 0 ? 1 : 0;
                if (currentRivalry[otherPosition]) {
                    usedTeams.add(currentRivalry[otherPosition]);
                }
            }
            
            // Return teams that aren't used elsewhere
            return teams.filter(team => !usedTeams.has(team));
        }

        function generateWeekCheckboxes() {
            const container = document.getElementById('weekCheckboxContainer');
            container.innerHTML = '';
            
            const totalWeeks = parseInt(document.getElementById('totalWeeks').value);
            
            for (let week = 1; week <= totalWeeks; week++) {
                const colDiv = document.createElement('div');
                colDiv.className = 'col-md-3 col-sm-4 col-6 mb-2';
                
                const isSelected = selectedRivalryWeeks.includes(week);
                
                colDiv.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${week}" 
                               id="week${week}" ${isSelected ? 'checked' : ''}>
                        <label class="form-check-label" for="week${week}">
                            Week ${week}
                        </label>
                    </div>
                `;
                
                container.appendChild(colDiv);
            }
        }

        function saveRivalryWeeks() {
            const checkboxes = document.querySelectorAll('#weekCheckboxContainer input[type="checkbox"]:checked');
            selectedRivalryWeeks = Array.from(checkboxes).map(cb => parseInt(cb.value));
            selectedRivalryWeeks.sort((a, b) => a - b);
            
            scheduleConfig.rivalryWeeks = selectedRivalryWeeks;
            updateRivalryWeeksDisplay();
            calculateScheduleInfo();
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('rivalryWeekModal'));
            modal.hide();
        }

        function updateRivalryWeeksDisplay() {
            const display = document.getElementById('rivalryWeeksDisplay');
            const text = document.getElementById('selectedWeeksText');
            
            if (selectedRivalryWeeks.length > 0) {
                text.textContent = `Weeks: ${selectedRivalryWeeks.join(', ')}`;
                display.style.display = 'block';
            } else {
                text.textContent = 'No rivalry weeks selected';
                display.style.display = 'none';
            }
        }

        function addRivalryInputUI(index, team1 = '', team2 = '') {
            const container = document.getElementById('rivalriesContainer');
            
            // Remove empty message if exists
            if (container.querySelector('.text-muted')) {
                container.innerHTML = '';
            }
            
            const rivalryDiv = document.createElement('div');
            rivalryDiv.className = 'rivalry-card';
            
            // Get available teams for each position
            const availableForPosition1 = getAvailableTeamsForRivalry(index, 0);
            const availableForPosition2 = getAvailableTeamsForRivalry(index, 1);
            
            // Add current selections back to available teams if they exist
            if (team1 && !availableForPosition1.includes(team1)) {
                availableForPosition1.push(team1);
            }
            if (team2 && !availableForPosition2.includes(team2)) {
                availableForPosition2.push(team2);
            }
            
            // Create availability indicators
            const pos1Available = availableForPosition1.length;
            const pos2Available = availableForPosition2.length;
            const totalTeams = teams.length;
            
            rivalryDiv.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <select class="form-select" onchange="updateRivalry(${index}, 0, this.value)">
                            <option value="">Select Team 1 (${pos1Available}/${totalTeams} available)</option>
                            ${availableForPosition1.map(team => `<option value="${team}" ${team === team1 ? 'selected' : ''}>${team}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2 text-center">
                        <span class="badge bg-primary">VS</span>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" onchange="updateRivalry(${index}, 1, this.value)">
                            <option value="">Select Team 2 (${pos2Available}/${totalTeams} available)</option>
                            ${availableForPosition2.map(team => `<option value="${team}" ${team === team2 ? 'selected' : ''}>${team}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger btn-sm" onclick="removeRivalry(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(rivalryDiv);
        }

        function calculateScheduleInfo() {
            const teamCount = parseInt(document.getElementById('teamCount').value);
            const totalWeeks = parseInt(document.getElementById('totalWeeks').value);
            const rivalryWeeksCount = selectedRivalryWeeks.length;
            
            scheduleConfig.totalWeeks = totalWeeks;
            scheduleConfig.rivalryWeeks = selectedRivalryWeeks;
            
            // Calculate matchups
            const totalPossibleMatchups = (teamCount * (teamCount - 1)) / 2;
            const rivalryMatchupsCount = rivalries.filter(r => r[0] && r[1]).length;
            const roundRobinMatchups = totalPossibleMatchups - rivalryMatchupsCount;
            
            const gamesPerWeek = Math.floor(teamCount / 2);
            const regularWeeks = totalWeeks - rivalryWeeksCount;
            const totalRegularGamesNeeded = regularWeeks * gamesPerWeek;
            
            // Calculate round robins needed
            const completeRoundRobins = Math.floor(totalRegularGamesNeeded / roundRobinMatchups);
            const remainingGamesAfterRoundRobins = totalRegularGamesNeeded - (completeRoundRobins * roundRobinMatchups);
            
            // Calculate if we need extra games (repeats)
            const needsExtraGames = remainingGamesAfterRoundRobins > 0;
            const maxGamesPerPair = completeRoundRobins + (needsExtraGames ? 1 : 0);
            
            const rivalryGames = rivalryWeeksCount * rivalryMatchupsCount;
            const totalGames = totalRegularGamesNeeded + rivalryGames;
            const gamesPerTeam = Math.floor(totalGames * 2 / teamCount);
            
            // Update schedule info
            document.getElementById('scheduleDetails').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <small><strong>Round Robin Analysis:</strong></small><br>
                        <small>• ${roundRobinMatchups} unique non-rivalry matchups</small><br>
                        <small>• ${completeRoundRobins} complete round robin(s)</small><br>
                        <small>• ${remainingGamesAfterRoundRobins} extra games needed</small><br>
                        <small>• Max ${maxGamesPerPair} games between any non-rival pair</small>
                    </div>
                    <div class="col-md-6">
                        <small><strong>Game Distribution:</strong></small><br>
                        <small>• ${gamesPerWeek} games per week (${teamCount}÷2)</small><br>
                        <small>• ${regularWeeks} regular weeks + ${rivalryWeeksCount} rivalry weeks</small><br>
                        <small>• ~${gamesPerTeam} games per team total</small><br>
                        <small>• ${totalGames} total games scheduled</small>
                    </div>
                </div>
            `;
            
            // Update help text
            updateAddRivalryButton();
        }

        function updateTeam(index, value) {
            teams[index] = value;
            generateRivalryInputsUI();
        }

        function updateRivalry(rivalryIndex, teamIndex, value) {
            if (!rivalries[rivalryIndex]) {
                rivalries[rivalryIndex] = ['', ''];
            }
            rivalries[rivalryIndex][teamIndex] = value;
            
            // Refresh the rivalry UI to update available teams in other dropdowns
            generateRivalryInputsUI();
        }

        function addRivalry() {
            const maxRivalries = Math.floor(teams.length / 2);
            
            if (rivalries.length >= maxRivalries) {
                alert(`Maximum rivalries reached! With ${teams.length} teams, you can only have ${maxRivalries} rivalry pairs.`);
                return;
            }
            
            rivalries.push(['', '']);
            generateRivalryInputsUI();
            updateAddRivalryButton();
        }

        function updateAddRivalryButton() {
            const maxRivalries = Math.floor(teams.length / 2);
            const addButton = document.querySelector('.btn.btn-success[onclick="addRivalry()"], .btn.btn-secondary[onclick="addRivalry()"]');
            
            if (addButton) {
                if (rivalries.length >= maxRivalries) {
                    addButton.disabled = true;
                    addButton.innerHTML = `<i class="fas fa-ban me-1"></i>Max Rivalries (${maxRivalries})`;
                    addButton.classList.remove('btn-success');
                    addButton.classList.add('btn-secondary');
                } else {
                    addButton.disabled = false;
                    addButton.innerHTML = `<i class="fas fa-plus me-1"></i>Add Rivalry (${rivalries.length}/${maxRivalries})`;
                    addButton.classList.remove('btn-secondary');
                    addButton.classList.add('btn-success');
                }
            }
            
            // Update help text
            const helpText = document.getElementById('rivalryHelpText');
            if (helpText) {
                helpText.textContent = `Rivalries create special matchup weeks. Each team can only have one rivalry partner. Maximum ${maxRivalries} rivalries with ${teams.length} teams.`;
            }
        }

        function removeRivalry(index) {
            rivalries.splice(index, 1);
            generateRivalryInputsUI();
            updateAddRivalryButton();
        }

        function autoGenerateRivalries() {
            const maxRivalries = Math.floor(teams.length / 2);
            
            if (confirm(`This will create ${maxRivalries} random rivalry pairs using all ${teams.length} teams. Continue?`)) {
                rivalries = [];
                
                // Create a copy of teams and shuffle it
                const availableTeams = [...teams];
                availableTeams.sort(() => Math.random() - 0.5);
                
                // Pair teams sequentially (ensures no team appears twice)
                for (let i = 0; i < maxRivalries && i * 2 + 1 < availableTeams.length; i++) {
                    rivalries.push([availableTeams[i * 2], availableTeams[i * 2 + 1]]);
                }
                
                generateRivalryInputsUI();
            }
        }

        function generateRandomTeamNames() {
            const randomNames = [
                'Lightning', 'Thunder', 'Storm', 'Blaze', 'Frost', 'Venom', 'Phoenix', 'Dragon',
                'Titans', 'Warriors', 'Knights', 'Spartans', 'Gladiators', 'Crusaders', 'Vikings', 'Pirates',
                'Eagles', 'Hawks', 'Falcons', 'Ravens', 'Wolves', 'Bears', 'Lions', 'Tigers',
                'Rockets', 'Comets', 'Meteors', 'Stars', 'Galaxy', 'Nebula', 'Cosmos', 'Orbit'
            ];
            
            const shuffled = randomNames.sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < teams.length; i++) {
                teams[i] = shuffled[i] || `Team ${i + 1}`;
            }
            
            generateTeamInputsUI();
            generateRivalryInputsUI();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data?')) {
                teams = teams.map((_, i) => `Team ${i + 1}`);
                rivalries = [];
                generateTeamInputsUI();
                generateRivalryInputsUI();
                document.getElementById('scheduleOutput').style.display = 'none';
                document.getElementById('statsCard').style.display = 'none';
            }
        }

        function validateInputs() {
            // Check if all teams are filled and unique
            const validTeams = teams.filter(team => team && team.trim());
            if (validTeams.length < teams.length) {
                alert('Please enter names for all teams.');
                return false;
            }

            const uniqueTeams = new Set(validTeams);
            if (uniqueTeams.size !== validTeams.length) {
                alert('Team names must be unique.');
                return false;
            }

            // Check if we have even number of teams
            if (teams.length % 2 !== 0) {
                alert('Number of teams must be even for proper scheduling.');
                return false;
            }

            // Validate rivalries if any exist
            const validRivalries = rivalries.filter(rivalry => 
                rivalry[0] && rivalry[1] && rivalry[0] !== rivalry[1]
            );
            
            if (rivalries.length > 0 && validRivalries.length !== rivalries.length) {
                alert('Please complete all rivalry configurations or remove incomplete ones.');
                return false;
            }

            // Check for duplicate teams across rivalries
            const usedInRivalries = new Set();
            for (const rivalry of validRivalries) {
                if (usedInRivalries.has(rivalry[0])) {
                    alert(`${rivalry[0]} is already in another rivalry. Each team can only have one rivalry partner.`);
                    return false;
                }
                if (usedInRivalries.has(rivalry[1])) {
                    alert(`${rivalry[1]} is already in another rivalry. Each team can only have one rivalry partner.`);
                    return false;
                }
                usedInRivalries.add(rivalry[0]);
                usedInRivalries.add(rivalry[1]);
            }

            // Check that rivalry weeks can accommodate all rivalry games
            if (validRivalries.length > 0 && selectedRivalryWeeks.length === 0) {
                alert('You have configured rivalries but no rivalry weeks selected. Please select rivalry weeks or remove rivalries.');
                return false;
            }
            
            // Check that rivalry weeks can fit all rivalry games
            const gamesPerWeek = Math.floor(teams.length / 2);
            const totalRivalrySlots = selectedRivalryWeeks.length * gamesPerWeek;
            if (validRivalries.length > totalRivalrySlots) {
                alert(`You have ${validRivalries.length} rivalries but only ${totalRivalrySlots} rivalry game slots (${selectedRivalryWeeks.length} weeks × ${gamesPerWeek} games/week). Please add more rivalry weeks or reduce rivalries.`);
                return false;
            }

            return true;
        }

        // Schedule generation functions (simplified for this example)
        function generateSchedule() {
            if (!validateInputs()) return;

            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('generateBtnText');
            const sportType = scheduleConfig.sportType;
            
            // Disable button immediately
            btn.disabled = true;
            
            // Trigger sport-specific animation
            if (sportType === 'fantasy_football') {
                triggerFootballKick();
                
                // Start actual generation after button transforms and gets kicked
                setTimeout(() => {
                    try {
                        const schedule = createSchedule();
                        currentSchedule = schedule;
                        displaySchedule(schedule);
                        updateStatistics(schedule);
                        
                        // Show success celebration
                        setTimeout(() => {
                            const toast = document.createElement('div');
                            toast.className = 'alert alert-success position-fixed';
                            toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px; animation: slideIn 0.5s ease-out;';
                            toast.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <span style="font-size: 1.5rem; margin-right: 10px;">🏈🎉</span>
                                    <div>
                                        <strong>FIELD GOAL!</strong><br>
                                        <small>Your fantasy football schedule is ready!</small>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(toast);
                            
                            setTimeout(() => {
                                toast.remove();
                            }, 4000);
                        }, 500);
                        
                    } catch (error) {
                        alert('Error generating schedule: ' + error.message);
                    } finally {
                        // Re-enable button and restore text
                        setTimeout(() => {
                            btn.disabled = false;
                            btnText.textContent = 'KICK!';
                        }, 500);
                    }
                }, 3000); // Wait for kick animation to complete
                
            } else {
                // Non-football sports - standard generation
                let loadingText = 'Generating...';
                switch(sportType) {
                    case 'fantasy_baseball':
                        loadingText = 'Pitching...';
                        break;
                    case 'basketball':
                        loadingText = 'Shooting...';
                        break;
                    case 'soccer':
                        loadingText = 'Scoring...';
                        break;
                }
                
                btnText.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${loadingText}`;

                setTimeout(() => {
                    try {
                        const schedule = createSchedule();
                        currentSchedule = schedule;
                        displaySchedule(schedule);
                        updateStatistics(schedule);
                    } catch (error) {
                        alert('Error generating schedule: ' + error.message);
                    } finally {
                        btn.disabled = false;
                        
                        // Restore original button text
                        switch(sportType) {
                            case 'fantasy_baseball':
                                btnText.textContent = 'Pitch Schedule!';
                                break;
                            case 'basketball':
                                btnText.textContent = 'Shoot Schedule!';
                                break;
                            case 'soccer':
                                btnText.textContent = 'Score Schedule!';
                                break;
                            default:
                                btnText.textContent = 'Generate Schedule';
                        }
                    }
                }, 1000);
            }
        }

        function createSchedule() {
            const teamCount = teams.length;
            const totalWeeks = scheduleConfig.totalWeeks;
            const rivalryWeeks = selectedRivalryWeeks;
            const gamesPerWeek = Math.floor(teamCount / 2);
            
            console.log(`Creating schedule: ${teamCount} teams, ${gamesPerWeek} games per week`);
            
            const schedule = {};
            
            // Step 1: Create all possible matchups
            const allMatchups = [];
            for (let i = 0; i < teamCount; i++) {
                for (let j = i + 1; j < teamCount; j++) {
                    allMatchups.push([teams[i], teams[j]]);
                }
            }
            console.log(`Total possible matchups: ${allMatchups.length}`);
            
            // Step 2: Separate rivalry pairs from regular matchups
            const rivalryPairs = rivalries.filter(r => r[0] && r[1]);
            const rivalryKeys = new Set(rivalryPairs.map(pair => 
                [pair[0], pair[1]].sort().join('|')
            ));
            
            const roundRobinMatchups = allMatchups.filter(matchup => 
                !rivalryKeys.has(matchup.slice().sort().join('|'))
            );
            console.log(`Rivalry pairs: ${rivalryPairs.length}, Round robin matchups: ${roundRobinMatchups.length}`);
            
            // Step 3: Place rivalry games in designated weeks
            rivalryWeeks.forEach(week => {
                schedule[week] = [...rivalryPairs];
                console.log(`Week ${week} (rivalry): ${rivalryPairs.length} games`);
            });
            
            // Step 4: Calculate regular weeks and required games
            const regularWeeks = [];
            for (let week = 1; week <= totalWeeks; week++) {
                if (!rivalryWeeks.includes(week)) {
                    regularWeeks.push(week);
                }
            }
            console.log(`Regular weeks: ${regularWeeks.length}`);
            
            const totalRegularGamesNeeded = regularWeeks.length * gamesPerWeek;
            console.log(`Total regular games needed: ${totalRegularGamesNeeded}`);
            
            // Step 5: Calculate how many times each matchup should be played
            const completeRoundRobins = Math.floor(totalRegularGamesNeeded / roundRobinMatchups.length);
            const extraGamesNeeded = totalRegularGamesNeeded - (completeRoundRobins * roundRobinMatchups.length);
            const maxGamesPerMatchup = completeRoundRobins + (extraGamesNeeded > 0 ? 1 : 0);
            
            console.log(`Complete round robins: ${completeRoundRobins}, Extra games: ${extraGamesNeeded}, Max per matchup: ${maxGamesPerMatchup}`);
            
            // Step 6: Create matchup usage tracker
            const matchupUsage = new Map();
            roundRobinMatchups.forEach(matchup => {
                const key = matchup.slice().sort().join('|');
                matchupUsage.set(key, 0);
            });
            
            // Step 7: Fill regular weeks using improved algorithm
            regularWeeks.forEach((week, weekIndex) => {
                console.log(`\nFilling week ${week}:`);
                const weekGames = [];
                const usedTeams = new Set();
                
                // Create a priority list of matchups for this week
                // Prioritize matchups that have been used less
                const availableMatchups = roundRobinMatchups.filter(matchup => {
                    const key = matchup.slice().sort().join('|');
                    const usage = matchupUsage.get(key);
                    return usage < maxGamesPerMatchup;
                });
                
                // Sort by usage (least used first), then randomize within each usage level
                availableMatchups.sort((a, b) => {
                    const keyA = a.slice().sort().join('|');
                    const keyB = b.slice().sort().join('|');
                    const usageA = matchupUsage.get(keyA);
                    const usageB = matchupUsage.get(keyB);
                    if (usageA !== usageB) return usageA - usageB;
                    return Math.random() - 0.5;
                });
                
                // Try to fill the week with exactly gamesPerWeek games
                let attempts = 0;
                const maxAttempts = availableMatchups.length * 2;
                
                while (weekGames.length < gamesPerWeek && attempts < maxAttempts) {
                    let gameAdded = false;
                    
                    for (const matchup of availableMatchups) {
                        if (weekGames.length >= gamesPerWeek) break;
                        
                        const key = matchup.slice().sort().join('|');
                        const usage = matchupUsage.get(key);
                        const team1Available = !usedTeams.has(matchup[0]);
                        const team2Available = !usedTeams.has(matchup[1]);
                        
                        if (usage < maxGamesPerMatchup && team1Available && team2Available) {
                            weekGames.push([...matchup]);
                            usedTeams.add(matchup[0]);
                            usedTeams.add(matchup[1]);
                            matchupUsage.set(key, usage + 1);
                            gameAdded = true;
                            console.log(`  Added: ${matchup[0]} vs ${matchup[1]} (usage now ${usage + 1})`);
                        }
                    }
                    
                    if (!gameAdded) break;
                    attempts++;
                }
                
                console.log(`Week ${week} completed with ${weekGames.length} games (target: ${gamesPerWeek})`);
                
                // CRITICAL: Ensure we always have the right number of games
                if (weekGames.length < gamesPerWeek) {
                    console.warn(`Week ${week} only has ${weekGames.length} games, need ${gamesPerWeek}`);
                    
                    // Emergency fill: Allow exceeding maxGamesPerMatchup if necessary
                    const emergencyMatchups = roundRobinMatchups.filter(matchup => {
                        return !usedTeams.has(matchup[0]) && !usedTeams.has(matchup[1]);
                    });
                    
                    for (const matchup of emergencyMatchups) {
                        if (weekGames.length >= gamesPerWeek) break;
                        
                        const team1Available = !usedTeams.has(matchup[0]);
                        const team2Available = !usedTeams.has(matchup[1]);
                        
                        if (team1Available && team2Available) {
                            weekGames.push([...matchup]);
                            usedTeams.add(matchup[0]);
                            usedTeams.add(matchup[1]);
                            
                            const key = matchup.slice().sort().join('|');
                            const currentUsage = matchupUsage.get(key) || 0;
                            matchupUsage.set(key, currentUsage + 1);
                            console.log(`  Emergency add: ${matchup[0]} vs ${matchup[1]}`);
                        }
                    }
                }
                
                schedule[week] = weekGames;
            });
            
            // Step 8: Final validation
            console.log('\n=== Final Schedule Validation ===');
            let maxUsage = 0;
            let totalRegularGames = 0;
            
            Object.keys(schedule).forEach(week => {
                const weekNum = parseInt(week);
                const gameCount = schedule[week].length;
                console.log(`Week ${week}: ${gameCount} games ${rivalryWeeks.includes(weekNum) ? '(rivalry)' : '(regular)'}`);
                
                if (!rivalryWeeks.includes(weekNum)) {
                    totalRegularGames += gameCount;
                }
            });
            
            matchupUsage.forEach((usage, matchup) => {
                maxUsage = Math.max(maxUsage, usage);
            });
            
            console.log(`Total regular games scheduled: ${totalRegularGames} (needed: ${totalRegularGamesNeeded})`);
            console.log(`Max usage per matchup: ${maxUsage} (allowed: ${maxGamesPerMatchup})`);
            
            return schedule;
        }

        function displaySchedule(schedule) {
            const content = document.getElementById('scheduleContent');
            content.innerHTML = '';
            
            Object.keys(schedule).sort((a, b) => parseInt(a) - parseInt(b)).forEach(week => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'schedule-week';
                
                const weekNum = parseInt(week);
                let weekType = '';
                let headerClass = 'schedule-week-header';
                
                if (selectedRivalryWeeks.includes(weekNum)) {
                    weekType = ' (Rivalry Week)';
                    headerClass += ' bg-warning';
                } else {
                    weekType = ' (Regular Season)';
                }
                
                weekDiv.innerHTML = `
                    <div class="${headerClass}">
                        <i class="fas fa-calendar-day me-2"></i>
                        Week ${week}${weekType}
                    </div>
                    <div class="schedule-week-body">
                        ${schedule[week].map((game, i) => `
                            <div class="game-item">
                                <span><strong>Game ${i + 1}:</strong></span>
                                <div>
                                    <span class="team-badge">${game[0]}</span>
                                    <span class="vs-divider">VS</span>
                                    <span class="team-badge">${game[1]}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                content.appendChild(weekDiv);
            });
            
            document.getElementById('scheduleOutput').style.display = 'block';
            document.getElementById('scheduleOutput').scrollIntoView({ behavior: 'smooth' });
        }

        function updateStatistics(schedule) {
            const totalGames = Object.values(schedule).reduce((sum, week) => sum + week.length, 0);
            const weeksUsed = Object.keys(schedule).length;
            const gamesPerTeam = Math.floor(totalGames * 2 / teams.length);
            
            // Calculate round robins more accurately
            const rivalryPairs = rivalries.filter(r => r[0] && r[1]);
            const totalPossibleMatchups = (teams.length * (teams.length - 1)) / 2;
            const roundRobinMatchups = totalPossibleMatchups - rivalryPairs.length;
            const regularWeeksCount = weeksUsed - selectedRivalryWeeks.length;
            const regularGames = totalGames - (selectedRivalryWeeks.length * rivalryPairs.length);
            const roundRobins = regularGames / roundRobinMatchups;
            
            document.getElementById('totalGamesCount').textContent = totalGames;
            document.getElementById('roundRobinsCount').textContent = roundRobins.toFixed(1);
            document.getElementById('gamesPerTeamCount').textContent = gamesPerTeam;
            document.getElementById('weeksUsedCount').textContent = weeksUsed;
            
            document.getElementById('statsCard').style.display = 'block';
        }

        function downloadSchedule() {
            if (!currentSchedule) return;
            
            let content = `# ${sportConfigs[scheduleConfig.sportType].name} Schedule\n\n`;
            content += `## League Configuration\n`;
            content += `- **Teams:** ${teams.length}\n`;
            content += `- **Total Weeks:** ${scheduleConfig.totalWeeks}\n`;
            content += `- **Rivalry Weeks:** ${selectedRivalryWeeks.length > 0 ? selectedRivalryWeeks.join(', ') : 'None'}\n\n`;
            
            content += `## Teams\n`;
            teams.forEach((team, i) => {
                content += `${i + 1}. ${team}\n`;
            });
            
            if (rivalries.length > 0) {
                content += `\n## Rivalry Pairs\n`;
                rivalries.forEach(rivalry => {
                    content += `- ${rivalry[0]} vs ${rivalry[1]}\n`;
                });
            }
            
            content += `\n## Weekly Schedule\n\n`;
            
            Object.keys(currentSchedule).sort((a, b) => parseInt(a) - parseInt(b)).forEach(week => {
                const weekNum = parseInt(week);
                let weekType = '';
                if (selectedRivalryWeeks.includes(weekNum)) {
                    weekType = ' (Rivalry Week)';
                } else {
                    weekType = ' (Regular Season)';
                }
                
                content += `### Week ${week}${weekType}\n`;
                currentSchedule[week].forEach((game, i) => {
                    content += `- **Game ${i + 1}:** ${game[0]} vs ${game[1]}\n`;
                });
                content += '\n';
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${scheduleConfig.sportType}_schedule_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printSchedule() {
            if (!currentSchedule) return;
            
            const printContent = document.getElementById('scheduleContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Sports Schedule</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .schedule-week { margin-bottom: 20px; border: 1px solid #ddd; }
                        .schedule-week-header { background: #f5f5f5; padding: 10px; font-weight: bold; }
                        .schedule-week-body { padding: 10px; }
                        .game-item { margin-bottom: 5px; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>${sportConfigs[scheduleConfig.sportType].name} Schedule</h1>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
